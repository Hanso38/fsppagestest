<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Have a Play - Finance Starter Pack</title>
      
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="Finance Starter Pack">
    <meta property="og:image" content="None/../graphics/TorQ-logo.png">
    <meta name="apple-mobile-web-app-title" content="Finance Starter Pack">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="../graphics/TorQ-logo.png">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../graphics/favicon.ico">
    <link rel="icon" type="image/x-icon" href="../graphics/favicon.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../assets/fonts/icon.eot?52m981');
      	src: url('../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../assets/stylesheets/application-a422ff04cc.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/palettes-05ab2406df.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
    <script src="../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class="palette-primary-indigo palette-accent-green">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
          </span>
        
        Have a Play
      </div>
    </div>
    
      
      <div class="button button-twitter" role="button" aria-label="Twitter">
        <a href="https://twitter.com/AquaQAnalytics" title="@AquaQAnalytics on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
      </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/AquaQAnalytics" title="@AquaQAnalytics on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/AquaQAnalytics/TorQ-Finance-Starter-Pack" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../graphics/TorQ-logo.png">
        </div>
      
      <div class="name">
        <strong>
          Finance Starter Pack
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          AquaQAnalytics/TorQ-Finance-Starter-Pack
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/AquaQAnalytics/TorQ-Finance-Starter-Pack/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/AquaQAnalytics/TorQ-Finance-Starter-Pack/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="..">
      Home
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Getting Started" href="../gettingstarted/">
      Getting Started
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Architecture" href="../architecture/">
      Architecture
    </a>
    
  </li>

          
            
  <li>
    <a class="current" title="Have a Play" href="./">
      Have a Play
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Gateway" href="#gateway">
                Gateway
              </a>
            </li>
          
            <li class="anchor">
              <a title="Examine the Logs" href="#examine-the-logs">
                Examine the Logs
              </a>
            </li>
          
            <li class="anchor">
              <a title="Reports" href="#reports">
                Reports
              </a>
            </li>
          
            <li class="anchor">
              <a title="Access Control" href="#access-control">
                Access Control
              </a>
            </li>
          
        </ul>
      
    
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
              
              <li>
                <a href="https://twitter.com/AquaQAnalytics" target="_blank" title="@AquaQAnalytics on Twitter">
                  @AquaQAnalytics on Twitter
                </a>
              </li>
            
            
              
              <li>
                <a href="https://github.com/AquaQAnalytics" target="_blank" title="@AquaQAnalytics on GitHub">
                  @AquaQAnalytics on GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="have-a-play">Have a Play</h1>
<h2 id="gateway">Gateway</h2>
<h3 id="queries">Queries</h3>
<p>Some example queries have been implemented on the RDB an HDB processes.
These are defined in $KDBCODE/rdb/examplequeries.q and
$KDBCODE/hdb/examplequeries.q. These can be run directly on the
processes themselves, or from the gateway which will join the results if
querying across processes. To test, connect to the gateway process
running on port 6007 from q process, qcon or from an IDE. An example is
shown below running from an IDE.</p>
<p><img alt="Gateway Queries Running from an
IDE" src="../graphics/gwqueries.png" /></p>
<p>Example queries are listed below.</p>
<pre><code>// From the gateway, run a query on the RDB
.gw.syncexec["select sum size by sym from trade";`rdb]

// Run a query on the HDB
.gw.syncexec["select count i by date from trade";`hdb]

// Run a freeform time bucketed query and join the results across the RDB and HDB
// Note that this is generally bad practice as the HDB query doesn't contain a date clause
.gw.syncexec["select sum size, max price by 0D00:05 xbar time from trade where sym=`IBM";`hdb`rdb]

// Run a query across the RDB and HDB which uses a different join function to add the data from both 
.gw.syncexecj["select sum size by sym from trade";`rdb`hdb;sum]

// Run the pre-defined functions - these are implemented to query the RDB and HDB as efficiently as possible

// Run a bucketed HLOC query, both as a string and in functional form
.gw.syncexec["hloc[2015.01.07;.z.d;0D12]";`hdb`rdb]
.gw.syncexec[(`hloc;2015.01.07;.z.d;0D12);`hdb`rdb]

// Run a count by sym across a date range, and add the results. 
// Run both as a string and in functional from
.gw.syncexecj["countbysym[2015.01.07;.z.d]";`hdb`rdb;sum]
.gw.syncexecj[(`countbysym;2015.01.07;.z.d);`hdb`rdb;sum]

// Run a gateway query with a bespoke join function to line up results and compare today's data with historic data
.gw.syncexecj[(`countbysym;2015.01.07;.z.d);`hdb`rdb;{(`sym xkey select sym,histavgsize:size%tradecount from x 0) lj `sym xkey select sym,todayavgsize:size%tradecount from x 1}]

// Send a query for a process type which doesn't exist
.gw.syncexec["select count i by date from trade";`hdb`rubbish]

// Send a query which fails
.gw.syncexec["1+`a";`hdb]
</code></pre>
<h3 id="resilience">Resilience</h3>
<p>The gateway handles backend processes failing and restarting. To test
it:</p>
<ol>
<li>
<p>Manually kill one of the HDB processes (close the process on
    Windows, use the kill command on Linux or OS X)</p>
</li>
<li>
<p>Run one of the gateway queries which uses an HDB</p>
</li>
<li>
<p>Kill the remaining HDB process</p>
</li>
<li>
<p>Re-run the query- the gateway should return a failure error</p>
</li>
<li>
<p>Restart one of the HDB processes. To do this either run the correct
    individual line from the start script, or run the full start script.</p>
</li>
<li>
<p>Re-run the gateway query- it should be successful</p>
</li>
</ol>
<p>Check the monitor for changes when killing and restarting processes.</p>
<h3 id="load-balancing">Load Balancing</h3>
<p>New processes can be dynamically added and they will register with the
gateway which will start running queries across them. To test it, create
3 client q processes which run queries against the gateway as below.
Note that the code below could be pasted into a q script and run for
each client.</p>
<pre><code>// open a connection
q)h:hopen `::6007:admin:admin
// function that will take 5 seconds to run on the HDB
q)f:{system $[.z.o like "w*";"timeout ";"sleep "],string x}
// function that will query the gateway
q)g:{(neg h)(`.gw.asyncexec;(f;x); `hdb); h[]}
// run the query, print the time
q)sendquery:{-1"query took ",(string (system"t g[",(string r),"]")%10*r:1+rand 5),"% of expected time";}
q)do[100;sendquery[]]
</code></pre>
<p>Each client is trying to run a query on the HDB which takes 5 seconds.
There are 3 clients, and only 2 HDB processes sitting behind the
gateway. Each query will therefore take between 5 and 10 seconds,
depending on arrival time. As the number of clients increases, the
average time will increase.</p>
<p>Assuming the environment variables are set up, a new HDB process can be
started like this:</p>
<pre><code>q torq.q -load hdb/database -p 31302 -U config/passwords/accesslist.txt -o 0 -proctype hdb -procname temphdb -debug
</code></pre>
<p>This will automatically connect to the gateway, and allow more queries
to be run in parallel.</p>
<h2 id="examine-the-logs">Examine the Logs</h2>
<p>Each process writes logs to $KDBLOG. These are standard out, standard
error, and usage logs. The usage logs are also stored in memory by
default, in the .usage.usage table. The table can be used to analyze
which queries are taking a long time, which users are sending a lot of
queries, the memory usage before and after each query, which queries are
failing etc.</p>
<h2 id="reports">Reports</h2>
<p>The Reporter process has a set of default “reports” configured in
$KDBCONFIG/reporter.csv. These are:</p>
<ul>
<li>
<p>A memory check which runs periodically against the RDB and emails an
    alert if the memory usage goes above a certain size</p>
</li>
<li>
<p>A count check which runs periodically against the RDB and emails an
    alert if a certain number of updates haven’t been received by a
    certain set of tables within a given period</p>
</li>
<li>
<p>A date check which runs periodically against the HDB after
    end-of-day and raises an alert if the HDB date range isn’t as
    expected</p>
</li>
<li>
<p>An example end-of-day report which runs against the RDB at a
    specific time and produces a csv report of high, low, open and close
    prices per instrument and emails it</p>
</li>
<li>
<p>The same example end-of-day report as above but running against the
    gateway which then forward it to the RDB</p>
</li>
</ul>
<p>The config can be modified to change the reports that are run. Some
example modifications would be changing the thresholds at which alerts
are generated, how often they are run, and what is done with the
results. New reports can also be created. The report process will need
to be restarted to load the new configuration.</p>
<h2 id="access-control">Access Control</h2>
<h3 id="adding-users">Adding Users</h3>
<p>For simplicity each process is password protected using the file
$KDBCONFIG/passwords/accesslist.txt file. This can be modified to have
different access lists for each process. To add a new user, add their
user:password combination to the file and either restart the process or
execute</p>
<pre><code>q)\u
</code></pre>
<p>within the process.</p>
<h3 id="user-privileges">User Privileges</h3>
<p>TorQ possesses utilities for controlling user access in the form of
different user identities with different access levels. For more
information on how to configure this, see the “Message Handlers” section
in the main TorQ document.</p>
          <aside class="copyright" role="note">
            
              Copyright &copy 2016 AquaQ Analytics Limited.  Kx &reg and kdb+ are registered trademarks of Kx Systems Inc. &ndash;
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../architecture/" title="Architecture">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Architecture
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '..';
      var repo_id  = 'AquaQAnalytics/TorQ-Finance-Starter-Pack';
    </script>
    <script src="../assets/javascripts/application-997097ee0c.js"></script>
    
    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', 'https://www.google-analytics.com/analytics.js', 'ga');
        /* General initialization */
        ga('create', 'UA-51911331-4', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
        /* Track outbound links */
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
        /* Register handler to log search on blur */
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    
  </body>
</html>